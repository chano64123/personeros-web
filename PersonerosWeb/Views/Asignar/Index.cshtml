@using PersonerosWeb.Resourses;
@using PersonerosWeb.Models;
@{
    ViewBag.Title = "Asignar Responsabilidades";
    List<SelectListItem> tiposUsuario = (List<SelectListItem>)ViewBag.tiposUsuario;
    List<SelectListItem> instituciones = (List<SelectListItem>)ViewBag.instituciones;
    ViewBag.urlBase = Recursos.baseUrlApi;
}

<div class="row mt-3">
    <div class="col text-black">
        <h2 class="text-center">@ViewBag.Title</h2>
        <hr />
    </div>
</div>
@using(Html.BeginForm("Agregar", "Asignar", FormMethod.Post, new { @class = "needs-validation", @novalidate = "novalidate" })) {
    @*@Html.HiddenFor(m => m.idPersona)*@
    <div class="card">
        <div class="card-body">
            <div class="row">
                <fieldset class="col">
                    <legend>Usuario</legend>
                    <div class="form-floating mb-3">
                        @Html.DropDownList("idTipoUsuario", tiposUsuario, new { @class = "form-select", @required = "required" })
                        @*@Html.LabelFor(model => model.idInstitucionVotacion)*@
                        <div class="invalid-feedback">Algo está mal!</div>
                    </div>
                    <div class="form-floating mb-3">
                        @Html.DropDownList("idUsuario", new List<SelectListItem>(), new { @class = "form-select", @required = "required" })
                        @*@Html.LabelFor(model => model.idInstitucionVotacion)*@
                        <div class="invalid-feedback">Algo está mal!</div>
                    </div>
                </fieldset>

                <fieldset class="col">
                    <legend>Institución - Mesa</legend>
                    <div class="form-floating mb-3" id="divInstituciones">
                        @Html.DropDownList("idInstitucion", instituciones, new { @class = "form-select", @required = "required" })
                        @*@Html.LabelFor(model => model.idInstitucionVotacion)*@
                        <div class="invalid-feedback">Algo está mal!</div>
                    </div>
                    <div class="form-floating mb-3" id="divMesas">
                        @Html.DropDownList("idMesa", new List<SelectListItem>(), new { @class = "form-select", @required = "required" })
                        @*@Html.LabelFor(model => model.idInstitucionVotacion)*@
                        <div class="invalid-feedback">Algo está mal!</div>
                    </div>
                </fieldset>
            </div>
            
            <div class="row">
                <div class="col align-self-center">
                    <button @*data-bs-dismiss="modal"*@ type="submit" class="col-12 btn btn-primary btn-lg">Guardar</button>
                </div>
                <div class="col align-self-center">
                    <a data-bs-dismiss="modal" class="col-12 btn btn-danger btn-lg">Cancelar</a>
                </div>
            </div>
        </div>
    </div>
}
<script src="~/Assets/js/validation/validation.bootstrap.js"></script>
<script type="text/javascript">
    //TIPOS DE USUARIO
    const idUsuarioPersonero = 1;
    const idUsuarioCordinador = 2;
    const idUsuarioEnlace = 3;

    var cmbTipoUsuario = $('#idTipoUsuario');
    var cmbUsuario = $('#idUsuario');
    var cmbInstitucion = $('#idInstitucion');
    var cmbMesa = $('#idMesa');
    var divMesas = document.getElementById('divMesas');
    var divInstituciones = document.getElementById('divInstituciones');

    //variables globales
    var urlbase = "https://personerosbackend.herokuapp.com/";
     
    //variables para los id selccionados de los divcersos combos     
    var idUsuarioSeleccionado = 0;
    var idTipoUsuarioSeleccionado = 0;
    var idInstitucionSeleccionada = 0;
    var idMesaSelccionada = 0;

    //para las cantidades maximas
    var maxMesa;
    var maxInstitucion;

    //variables para los objetos
    var usuarios;
    var instituciones;
    var mesas;
    var institucionesData;

    $(document).ready(function () {

        instituciones = @Html.Raw(Json.Encode(ViewBag.instituciones));

        institucionesData = armarObjetoInstituciones(instituciones);
        console.log(institucionesData)

        crearComboBusqueda(cmbTipoUsuario, 'Seleccione un Tipo de Usuario');
        crearComboBusqueda(cmbUsuario, 'Selecicone un Usuario');
        crearComboBusqueda(cmbInstitucion, 'Seleccione una Institución');
        crearComboBusqueda(cmbMesa, 'Seleccione una Mesa');

        //eventos
        $('#idTipoUsuario').on('select2:select', function (e) {
            var data = e.params.data;
            idTipoUsuarioSeleccionado = data.id;

            limpiarCombo(cmbUsuario);
            mostrarAlertBusqueda("Buscando usuarios del tipo " + data.text);
            fetchUsersByUserTypeId(idTipoUsuarioSeleccionado).then(users => {
                usuarios = users
                var cantidadUsuarios = usuarios.length;
                if (cantidadUsuarios >= 1) {
                    var datos = armarObjetoUsuario(usuarios);
                    //aca se cargan los nuevos elementos al combo
                    crearComboBusqueda(cmbUsuario, 'Seleccione un Usuario', '', datos)
                    Swal.fire("Bien", `Se encontrarón ${cantidadUsuarios} usuarios del tipo ${data.text}`, "success")
                } else {
                    Swal.fire("Error", `No se encontraron usuarios del tipo ${data.text}, primero cree uno`, "error")
                }
            });
            asignarComboInstitucionMesa(idTipoUsuarioSeleccionado);
        });

        $('#idUsuario').on('select2:select', function (e) {
            var data = e.params.data;
            idUsuarioSeleccionado = data.id;
            maxMesa = obtenerCantidadMaximaMesas(idUsuarioSeleccionado);
            maxInstitucion = obtenerCantidadMaximaInstituciones(idUsuarioSeleccionado);

            limpiarCombo(cmbInstitucion)
            if (idTipoUsuarioSeleccionado == idUsuarioPersonero) {
                crearComboBusqueda(cmbInstitucion, "Seleccione una institucion", '', institucionesData, false, maxInstitucion);
                crearComboBusqueda(cmbMesa, "Seleccione una o más mesas", '', '', true, maxMesa);
            } else if (idTipoUsuarioSeleccionado == idUsuarioEnlace || idTipoUsuarioSeleccionado == idUsuarioCordinador) {
                crearComboBusqueda(cmbInstitucion, "Seleccione una o más instituciones", '', institucionesData, true, maxInstitucion);
            }

            console.log("maxMesa => " + maxMesa)
            console.log("maxInstitucion => " + maxInstitucion)
        });

        $('#idInstitucion').on('select2:select', function (e) {
            var data = e.params.data;
            idInstitucionSeleccionada = data.id;

            if (idTipoUsuarioSeleccionado == idUsuarioEnlace || idTipoUsuarioSeleccionado == idUsuarioCordinador) {
                console.log("me salgo p")
                return;
            }



            limpiarCombo(cmbMesa);
            mostrarAlertBusqueda("Buscando mesas de la institución " + data.text);
            fetchMesasByInstitucionId(idInstitucionSeleccionada).then(tables => {
                mesas = tables;
                var cantidadMesas = mesas.length;
                if (cantidadMesas >= 1) {
                    var datos = armarObjetoMesa(mesas);
                    if (idUsuarioSeleccionado != 0) {
                        crearComboBusqueda(cmbMesa, "Seleccione una o más mesas", '', datos, true, maxMesa)
                    }
                    Swal.fire("Bien", `Se encontrarón ${cantidadMesas} mesas`, "success")
                } else {
                    Swal.fire("Error", `No se encontraron mesas de la institución ${data.text}, primero cree una`, "error")
                }
            });
        });
    });

    //BUSQUEDAS DE DATOS
    async function fetchUsersByUserTypeId(idTipoUsuario) {
        var endpoint = "api/Usuario/TipoUsuario/";
        var url = urlbase + endpoint + idTipoUsuario;
        const response = await fetch(url);
        const result = await response.json();
        const users = await result.result;
        return users;
    }

    async function fetchMesasByInstitucionId(idInstitucion) {
        var endpoint = "api/Mesa/Institucion/";
        var url = urlbase + endpoint + idInstitucion;
        const response = await fetch(url);
        const result = await response.json();
        const tables = await result.result;
        return tables;
    }

    //ARMANDO OBJETOS DE COMBOS
    function armarObjetoUsuario(usuarios) {
        let nombres = usuarios.map(x => ({
            id: x.idUsuario,
            text: x.persona.nombres + " " + x.persona.apellidoPaterno + " " + x.persona.apellidoMaterno,
            selected: false
        }));

        return nombres;
    }

    function armarObjetoMesa(mesas) {
        let numeros = mesas.map(x => ({
            id: x.idMesa,
            text: x.numero,
            selected: false
        }));

        return numeros;
    }

    function armarObjetoInstituciones(instituciones) {
        let distritosUnicos = obtenerElementosUnicos(instituciones)
        let nombres = distritosUnicos.map(x => ({
            text: x,
            children: crearObjetoInstitucion(x, instituciones)
        }));
        return nombres;
    }

    function crearObjetoInstitucion(distrito, instituciones) {
        return instituciones.filter(x => x.Group.Name == distrito).map(y => ({
            id: y.Value,
            text: y.Text,
            selected: false
        }));
    }

    //FILTROS UNICOS
    function obtenerElementosUnicos(instituciones){
        let todosDistritos = instituciones.map(item => {
            return item.Group.Name;
        });
        const dataArr = new Set(todosDistritos);
        let distritos = [...dataArr];
        return distritos;
    }

    //OCULTANDO O MOSTRANDO LOS COMBOS
    function asignarComboInstitucionMesa(idTipoUsuario) {
        limpiarCombo(cmbInstitucion);
        switch (parseInt(idTipoUsuario)) {
            case idUsuarioPersonero:
                mostrarElemento(divMesas)
                cmbMesa.attr("required","required")
                crearComboBusqueda(cmbInstitucion, "Seleccione una Institución", '', institucionesData, false)
                break;
            case idUsuarioCordinador:
                ocultarElemento(divMesas)
                cmbMesa.removeAttr("required")
                crearComboBusqueda(cmbInstitucion, "Seleccione una o más instituciones", '', institucionesData, true)
                break;
            case idUsuarioEnlace:
                ocultarElemento(divMesas);
                cmbMesa.removeAttr("required")
                crearComboBusqueda(cmbInstitucion, "Seleccione una o más instituciones", '', institucionesData, true)
                break;
        }
        //limpiarCombo(cmbInstitucion)
        limpiarSeleccion(cmbInstitucion);
        limpiarCombo(cmbMesa);
    }

    function fetchUserById(idUsuario) {
        return usuarios.find(x => x.idUsuario == idUsuario)
    }

    //PARA OBTENER MAXIMOS
    function obtenerCantidadMaximaInstituciones(idUsuario) {
        var cantidadMaxima = fetchUserById(idUsuario).cantidadMaximaInstituciones
        return cantidadMaxima;
    }

    function obtenerCantidadMaximaMesas(idUsuario) {
        var cantidadMaxima = fetchUserById(idUsuario).cantidadMaximaMesas
        return cantidadMaxima;
    }


    //APOYO
    function limpiarSeleccion(elemento) {
        elemento.val(null).trigger("change");
    }

    function limpiarCombo(elemento) {
        elemento.empty();
    }
</script>




@*<div class="project-description">

    <h4>Descripción de proyecto</h4>
    <ul class="nav nav-pills pb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-enlaces-tab" data-bs-toggle="pill" data-bs-target="#pills-enlaces" type="button" role="tab" aria-controls="pills-enlaces" aria-selected="false">
                Enlaces
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-coordinadores-tab" data-bs-toggle="pill" data-bs-target="#pills-coordinadores" type="button" role="tab" aria-controls="pills-coordinadores" aria-selected="false">
                Coordinadores
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-personeros-tab" data-bs-toggle="pill" data-bs-target="#pills-personeros" type="button" role="tab" aria-controls="pills-personeros" aria-selected="false">
                Personeros
            </button>
        </li>
    </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-enlaces" role="tabpanel" aria-labelledby="pills-enlaces-tab">
            <div class="col-12 table-responsive mt-2 mx-auto">
                Aca lo de enlaces
            </div>
        </div>

        <div class="tab-pane fade" id="pills-coordinadores" role="tabpanel" aria-labelledby="pills-coordinadores-tab">
            <div class="col-12 table-responsive mt-2 mx-auto">
                Aca lo de coordinadores
            </div>
        </div>
        <div class="tab-pane fade" id="pills-personeros" role="tabpanel" aria-labelledby="pills-personeros-tab">
            <div class="col-12 table-responsive mt-2 mx-auto">
                Aca lo de personeros
            </div>
        </div>
        <div class="tab-pane fade" id="pills-reporte" role="tabpanel" aria-labelledby="pills-reporte-tab">
            <div id="container"></div>
        </div>
    </div>
</div>*@